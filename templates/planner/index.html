{% load static %}
<html>
    <head>
        <title>Planner</title>
        <link href="{% static 'planner/style.css' %}" rel="stylesheet" type="text/css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

        <script>

         function getCookie(name) {
             var cookieValue = null;
             if (document.cookie && document.cookie != '') {
                 var cookies = document.cookie.split(';');
                 for (var i = 0; i < cookies.length; i++) {
                     var cookie = jQuery.trim(cookies[i]);
                     // Does this cookie string begin with the name we want?
                     if (cookie.substring(0, name.length + 1) == (name + '=')) {
                         cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                         break;
                     }
                 }
             }
             return cookieValue;
         }
         var csrftoken = getCookie('csrftoken');

         function csrfSafeMethod(method) {
             // these HTTP methods do not require CSRF protection
             return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
         }
         function sameOrigin(url) {
             // test that a given url is a same-origin URL
             // url could be relative or scheme relative or absolute
             var host = document.location.host; // host + port
             var protocol = document.location.protocol;
             var sr_origin = '//' + host;
             var origin = protocol + sr_origin;
             // Allow absolute or scheme relative URLs to same origin
             return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                    (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                    // or any other URL that isn't scheme relative or absolute i.e relative.
                    !(/^(\/\/|http:|https:).*/.test(url));
         }
         $.ajaxSetup({
             beforeSend: function(xhr, settings) {
                 if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                     // Send the token to same-origin, relative URLs only.
                     // Send the token only if the method warrants CSRF protection
                     // Using the CSRFToken value acquired earlier
                     xhr.setRequestHeader("X-CSRFToken", csrftoken);
                 }
             }
         });

         // Actual code
         $(document).ready(function(){
             $(document).on("click", "li.task", function() {
                 var clickedTask = $(this);
                 var taskId = clickedTask.attr("data-task-id");
                 $.post("/planner/toggle",
                        {task_id: taskId},
                        function (result) {
                            clickedTask.replaceWith(result);
                        });
                 
             });
         })
        </script>
    </head>

    <body>

        <form action="{% url 'add' %}" method="POST">
            {% csrf_token %}
            {{ form }}
            <input type="submit" value="Add task"/>
        </form>


        <ul>
            {% for task in tasks %}
                {% if task.done %}
                <li class="task task-completed" data-task-id="{{ task.id }}">{{ task.title }}</li>
                {% else %}
                <li class="task" data-task-id="{{ task.id }}">{{ task.title }}</li>
                {% endif %}
            {% endfor %}
        </ul>
    </body>
</html>